version: 2.1
#commands:
#    bits-artifact-number:
#        parameters:
#            value:
#                default: "latest"
#                type: string
#        steps:
#            - run: echo "Hello <<parameters.value>>"
jobs:
    bits-build:
        working_directory: ~/nova
        docker:
            -   image: circleci/node:12-browsers
        steps:
            -   checkout:
                    path: ~/nova
            -   run:
                    working_directory: ~/nova/packages/bits
                    name: Install dependencies
                    command: yarn install
            -   run:
                    working_directory: ~/nova/packages/bits
                    name: Assemble
                    command: yarn run assemble
            -   persist_to_workspace:
                    root: .
                    paths:
                        - .
    bits-unit-test:
        working_directory: ~/nova/packages/bits
        docker:
            -   image: circleci/node:12-browsers
        steps:
            -   attach_workspace:
                    at: ~/nova
            -   run:
                    name: Unit tests
                    command: yarn run test
    bits-e2e-test:
        working_directory: ~/nova
        machine:
            image: ubuntu-2004:202010-01
        environment:
            PROJECT_DIR: ~/nova/packages/bits
        steps:
            -   attach_workspace:
                    at: ~/nova
            -   run:
                    command: pwd; ls
            -   run:
                    name: Start Selenium docker image
                    command: docker-compose up -d --build selenium
            -   run:
                    name: E2E tests
                    command: docker-compose run --user="$UID" build npm run e2e:ci --prefix ./packages/bits
            -   run:
                    name: Cleanup
                    command: docker-compose down -v --rmi="all"
    bits-visual-test:
        working_directory: ~/nova
        machine:
            image: ubuntu-2004:202010-01
        environment:
            PROJECT_DIR: ~/nova/packages/bits
        steps:
            -   attach_workspace:
                    at: ~/nova
            -   run:
                    command: pwd; ls
            -   run:
                    name: Start Selenium docker image
                    command: docker-compose up -d --build selenium
            -   run:
                    name: Visual tests
                    command: docker-compose run --user="$UID" build npm run visual:ci --prefix ./packages/bits
            -   run:
                    name: Cleanup
                    command: docker-compose down -v --rmi="all"
    bits-publish:
        working_directory: ~/nova/packages/bits
        docker:
            -   image: circleci/node:12-browsers
        steps:
            -   attach_workspace:
                    at: ~/nova
#            -   run:
#                    name: Create bits package
#                    command: npm pack ./dist
            -   run:
                    name: Setup env variables
                    command: |
                        echo "export BIT_NUM='123'" >> $BASH_ENV
    charts-build:
        working_directory: ~/nova
        docker:
            -   image: circleci/node:12-browsers
        steps:
            -   checkout:
                    path: ~/nova
#            -   run:
#                    name: Download Bits Artifact
#                    # TODO: replace "207" with correct build number
#                    command: |
#                        curl -H "Circle-Token: ${CIRCLE_API_TOKEN}" https://circleci.com/api/v1.1/project/github/solarwinds/nova/207/artifacts \
#                        | grep -o 'https://[^"]*' \
#                        | wget --verbose --header "Circle-Token: ${CIRCLE_API_TOKEN}" --input-file -
            -   run:
                    name: Artifact test
                    command: echo $BIT_NUM
#            -   run:
#                    working_directory: ~/nova/packages/charts
#                    name: Install Bits
#                    command: yarn add ~/nova/bits-package.tgz
#            -   run:
#                    working_directory: ~/nova/packages/charts
#                    name: Install dependencies
#                    command: yarn install
#            -   run:
#                    working_directory: ~/nova/packages/charts
#                    name: Assemble
#                    command: yarn run assemble
            -   persist_to_workspace:
                    root: .
                    paths:
                        - .

workflows:
    version: 2
    nova:
        jobs:
            -   bits-publish:
                    context: nova-env
            -   charts-build:
                    context: nova-env
                    requires:
                        - bits-publish
